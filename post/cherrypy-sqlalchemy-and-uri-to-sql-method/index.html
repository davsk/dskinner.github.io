	<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.15-DEV" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> CherryPy, SQLAlchemy, and URI to SQL method &middot; All Things Related </title>

  
  <link rel="stylesheet" href="http://blog.dasa.cc/css/poole.css">
  <link rel="stylesheet" href="http://blog.dasa.cc/css/syntax.css">
  <link rel="stylesheet" href="http://blog.dasa.cc/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="All Things Related" />
</head>

	<body class="">
		<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://blog.dasa.cc/"><h1>All Things Related</h1></a>
      <p class="lead">
       despiteallobjections return 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
        <li><a href="https://github.com/dskinner"> Github </a></li>
      
        <li><a href="https://www.livecoding.tv/dskinner/"> Livecoding.tv </a></li>
      
    </ul>

    <p>&copy; 2016. All rights reserved. </p>
  </div>
</div>


		<div class="content container">
			<div class="post">
			 	<h1>CherryPy, SQLAlchemy, and URI to SQL method</h1>
			  <span class="post-date">Thu, Aug 14, 2008</span>
			      <p>Ok some basic info first. I have sqlalchemy objects defined. I use cherrypy and have been writing methods for doing queries to my tables in the various means ive learned how over the past couple years. that is to say,</p>

<p><code>/show_actor?id=4&amp;production_id=2</code></p>

<p>I keep looking at this code and thinking, this just isn&rsquo;t right, i was even recently looking at the turbogears2 wiki example (getting ideas for decorator usage and such) and seeing similar code, Again thinking, this just isn&rsquo;t right. Then somewhere between thinking and writing some code, i ended up halfway through the following and dont know how i got there. Basically its a uri to sql method. I make use of cherrypy&rsquo;s default method to traverse the uri that gets passed as *args &hellip; well traverse it as in translate it into traversing my sql tables. Its all very short and concise i think.</p>

<p>I got the first draft of my uri to sql done, it goes something like this,</p>

<pre><code>@expose
def default(self, *args, **kwargs):
    for n in args:
        if n in globals():
            query=Session.query(globals()[n])
    for k,v in make_filters(args):
        query=query.filter(globals()[k].name==v)
    yield json(query.all())
</code></pre>

<p>and uses this outside function</p>

<pre><code>def make_filters(uri):
    for n in range(len(uri)):
        if not n%2 and n+1 &lt; len(uri):
            yield [uri[n], uri[n+1]]
</code></pre>

<p>Basically now, the args passed to my default method let me traverse my sql tables like it was a directory tree. So you might say, i can open my folder Productions and find &ldquo;aa&rdquo; in there, and then i can open my Capture data related to &ldquo;aa&rdquo; and find MC001, or go to my Actor folder and get all my actor files such as &ldquo;Jon&rdquo; all accessible via</p>

<p><code>/show/Production/aa/Capture/MC001</code></p>

<p>or</p>

<p><code>/show/Production/aa/Actor/Jon</code></p>

<p>then using keyword arguments like</p>

<p><code>/show/Production/aa/Actor/Jon?type=json</code></p>

<p>i can specify special conditions or whatever and ive totally eliminated this really lame reiterative code of multiple methods for calling different data like /show_actor?prod_id=1, or calls with multiple if statements for handling what im asking for and its totally recursive no matter how deeply nested my tables are.</p>

<p>Im sure theres tons of problems and some shortsightedness here, and im still a relative newb to python (going on 6 months of use now i think) but anyway, i really dig this. Now I can start coding my ajax app to grab this or grab that and as I define tables through sqlalchemy, i will automatically be able to access my data.</p>

<p>Some things I need/want to do now is to provide custom filter options via keyword arguments and some sort of deliver data as type .. w/e, json, xml, yaml, yadda yadda yadda</p>

<p>Also to note, i call a json method in my code, thats part of a (probably overly complicated) generator i wrote that takes an sqlalchemy result object and produces a usable dict that gets dumped to json. It needs some extra work I think to be more useful but does what i need it to for now. Heres the code for that</p>

<pre><code>def gmap(obj):
    for item in obj.__dict__.items():
        if item[0][0] is '_':
            continue
        if isinstance(item[1], unicode):
            yield [item[0], str(item[1])]
        else:
            yield item

def json(obj):
    if isinstance(obj, list):
        return simplejson.dumps( map(lambda x: dict(x), map(lambda x: gmap(x), obj)) )
    else:
        return simplejson.dumps( dict(gmap(obj)) )
</code></pre>

<p>Thanks to google&rsquo;s advanced python talk on video.google for breaking down some key concepts on generators and such.</p>

			</div>

			
		</div>

  </body>
</html>
